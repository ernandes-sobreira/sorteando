<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Sorteador Pro ‚ú®</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#7c3aed">

  <style>
    :root{
      --bg1:#0b1220; --bg2:#111a2e;
      --card: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.12);
      --txt:#eaf0ff;
      --muted: rgba(234,240,255,.72);
      --accent:#7c3aed;
      --accent2:#22c55e;
      --danger:#ef4444;
      --warn:#f59e0b;
      --shadow: 0 18px 60px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:18px;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color: var(--txt);
      background:
        radial-gradient(1200px 600px at 10% 10%, rgba(124,58,237,.28), transparent 55%),
        radial-gradient(900px 600px at 90% 25%, rgba(34,197,94,.20), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height:100vh;
    }
    .wrap{max-width:980px; margin:0 auto;}
    header{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; margin-bottom:14px;
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:900;}
    .logo{
      width:40px;height:40px;border-radius:14px;
      background: linear-gradient(135deg, rgba(124,58,237,1), rgba(34,197,94,1));
      box-shadow: 0 14px 34px rgba(124,58,237,.35);
      display:grid; place-items:center;
    }
    .badge{
      font-size:12px; padding:6px 10px; border-radius:999px;
      background: rgba(255,255,255,.08);
      border: 1px solid var(--stroke);
      color: var(--muted);
    }
    .grid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:14px;
    }
    @media (max-width: 860px){ .grid{grid-template-columns:1fr} }
    .card{
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: 18px;
      padding: 14px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    h2{margin:0 0 8px; font-size:16px}
    .sub{color:var(--muted); font-size:13px; margin-top:2px}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .row > *{flex:1}
    .row .tight{flex:0 0 auto}

    input, button, select{
      font-size:16px;
      border-radius: 14px;
      padding: 11px 12px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color: var(--txt);
      outline:none;
    }
    input::placeholder{color: rgba(234,240,255,.45)}
    select{background: rgba(255,255,255,.06)}
    .btn{
      cursor:pointer;
      font-weight:850;
      display:flex; align-items:center; justify-content:center; gap:10px;
      user-select:none;
    }
    .btn:active{transform: scale(.99)}
    .btn-primary{background: linear-gradient(135deg, rgba(124,58,237,.92), rgba(124,58,237,.55)); border-color: rgba(124,58,237,.55);}
    .btn-green{background: linear-gradient(135deg, rgba(34,197,94,.92), rgba(34,197,94,.50)); border-color: rgba(34,197,94,.55);}
    .btn-danger{background: linear-gradient(135deg, rgba(239,68,68,.92), rgba(239,68,68,.50)); border-color: rgba(239,68,68,.55);}
    .btn-ghost{background: rgba(255,255,255,.05);}
    .btn[disabled]{opacity:.55; cursor:not-allowed}
    .divider{height:1px; background: rgba(255,255,255,.10); margin:12px 0}

    /* chips */
    .chips{display:flex; flex-wrap:wrap; gap:10px; margin-top:10px}
    .chip{
      padding:10px 12px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      cursor:pointer;
      display:flex; align-items:center; gap:10px;
      max-width:100%;
    }
    .chip strong{font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width: 240px;}
    .chip small{font-size:12px; color: var(--muted)}
    .chip.selected{border-color: rgba(124,58,237,.60); background: rgba(124,58,237,.18); box-shadow: 0 0 0 4px rgba(124,58,237,.14);}
    .chip.done{border-color: rgba(34,197,94,.45); background: rgba(34,197,94,.14);}
    .miniBtn{
      border:none; background: transparent; color: rgba(234,240,255,.90);
      padding:6px 8px; border-radius: 10px; cursor:pointer;
    }
    .miniBtn:hover{background: rgba(255,255,255,.07)}
    .miniBtn.del{color: rgba(239,68,68,.92)}
    .miniBtn.edit{color: rgba(245,158,11,.95)}

    /* stage */
    .stage{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      padding: 14px;
      position: relative;
      overflow:hidden;
    }
    .stage::before{
      content:"";
      position:absolute; inset:-40% -20%;
      background: radial-gradient(circle at 30% 30%, rgba(124,58,237,.26), transparent 55%),
                  radial-gradient(circle at 70% 45%, rgba(34,197,94,.22), transparent 55%);
      filter: blur(12px);
    }
    .stage > *{position:relative}
    .wheel{display:flex; align-items:center; justify-content:center; height: 92px; margin: 10px 0 8px;}
    .slot{
      width: 92px; height: 92px; border-radius: 26px;
      background: rgba(17,24,39,.65);
      border: 1px solid rgba(255,255,255,.12);
      display:grid; place-items:center;
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
      font-size: 44px;
    }
    .rolling .slot{animation: wobble .18s ease-in-out infinite alternate;}
    @keyframes wobble{ from{transform: rotate(-2deg) scale(1.01)} to{transform: rotate(2deg) scale(1.03)} }
    .hint{text-align:center; color: var(--muted); font-size: 13px;}
    .result{
      margin-top: 10px;
      padding: 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      min-height: 72px;
    }
    .result.ok{border-color: rgba(34,197,94,.40); background: rgba(34,197,94,.10)}
    .result.bad{border-color: rgba(239,68,68,.45); background: rgba(239,68,68,.10)}
    .confetti{ position:absolute; inset:0; pointer-events:none; overflow:hidden;}
    .confetti i{
      position:absolute; width:10px; height:16px; border-radius:4px;
      opacity:.95;
      animation: fall 1100ms linear forwards;
    }
    @keyframes fall{ to{ transform: translateY(120vh) rotate(520deg);} }

    .kpi{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
    .kpi .box{
      flex:1; border-radius: 16px; padding:10px 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      min-width: 140px;
    }
    .kpi .box b{display:block; font-size:18px}
    .kpi .box span{color: var(--muted); font-size:12px}
    .toast{margin-top:10px; color: var(--muted); font-size:13px;}
  </style>
</head>

<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo"><span>üé≤</span></div>
      <div>
        <div style="font-size:18px">Sorteador Pro</div>
        <div class="sub">amigo oculto ‚Ä¢ sala de aula ‚Ä¢ qualquer sorteio</div>
      </div>
    </div>
    <div class="badge" id="status">sem sorteio</div>
  </header>

  <div class="grid">

    <!-- ITENS -->
    <section class="card">
      <h2>üßæ Lista</h2>
      <div class="sub">Adicione, edite e exclua itens. Toque para selecionar.</div>

      <div class="divider"></div>

      <div class="row">
        <input id="novoNome" placeholder="Ex: Maria / Grupo 1 / Tema A / Jo√£o..." />
        <button class="btn btn-primary tight" style="min-width:140px" id="btnAdd">‚ûï Adicionar</button>
      </div>

      <div class="toast" id="msg"></div>
      <div class="chips" id="chips"></div>

      <div class="divider"></div>

      <div class="row">
        <button class="btn btn-ghost" id="btnExemplo">‚ú® Exemplo</button>
        <button class="btn btn-danger" id="btnReset">üß® Reset</button>
      </div>

      <div class="kpi">
        <div class="box"><b id="kTotal">0</b><span>itens</span></div>
        <div class="box"><b id="kDone">0</b><span>marcados (revelados)</span></div>
      </div>
    </section>

    <!-- MODO / SORTEIO -->
    <section class="card">
      <h2>üéØ Modo do sorteio</h2>
      <div class="sub">Escolha o tipo: amigo oculto, sorteio simples ou ordem aleat√≥ria.</div>

      <div class="divider"></div>

      <div class="row">
        <select id="modo">
          <option value="amigo">Amigo oculto (ningu√©m tira a si mesmo)</option>
          <option value="simples">Sorteio simples (1 ganhador)</option>
          <option value="multi">Sorteio multi (N ganhadores)</option>
          <option value="ordem">Ordem aleat√≥ria (embaralhar lista)</option>
        </select>
        <input id="qtd" type="number" min="1" value="3" title="Quantidade (modo multi)" />
      </div>

      <div class="divider"></div>

      <div class="stage">
        <div class="confetti" id="confetti"></div>

        <div class="row">
          <button class="btn btn-green" id="btnGerar">üé∞ GERAR / SORTEAR (tchannn)</button>
        </div>

        <div class="wheel" id="wheel"><div class="slot" id="slot">‚ú®</div></div>
        <div class="hint" id="hint">Selecione um item e clique em ‚ÄúREVELAR‚Äù (no modo amigo).</div>

        <div class="divider"></div>

        <div class="row">
          <button class="btn btn-primary" id="btnRevelar" disabled>üëÄ REVELAR</button>
          <button class="btn btn-ghost" id="btnOcultar" disabled>üßº OCULTAR / PR√ìXIMO</button>
        </div>

        <div class="result" id="resultado">Aguardando‚Ä¶</div>
      </div>

      <div class="toast" id="toast2"></div>
    </section>

  </div>
</div>

<script>
(() => {
  // ---------- Storage ----------
  const KEY = "sorteador_pro_v1";
  const saveState = () => {
    const data = {
      names,
      selected,
      revealed: Array.from(revealed),
      drawReady,
      mode: modoEl.value,
      qtd: qtdEl.value
    };
    localStorage.setItem(KEY, JSON.stringify(data));
  };
  const loadState = () => {
    try{
      const raw = localStorage.getItem(KEY);
      if(!raw) return false;
      const data = JSON.parse(raw);
      if(!data || !Array.isArray(data.names)) return false;
      names = data.names;
      selected = data.selected ?? null;
      revealed = new Set(data.revealed || []);
      drawReady = !!data.drawReady;
      modoEl.value = data.mode || "amigo";
      qtdEl.value = data.qtd || 3;
      return true;
    }catch(e){ return false; }
  };

  // ---------- Estado ----------
  let names = [];
  let selected = null;
  let pairs = {};
  let revealed = new Set();
  let drawReady = false;

  const faces = ["üéÅ","‚ú®","üéÑ","üéÖ","üß¶","ü¶å","üç¨","‚≠ê","üîî","üéÄ","üéØ","üèÜ","üé≤","üß†"];

  // ---------- Elements ----------
  const statusEl = document.getElementById("status");
  const chipsEl = document.getElementById("chips");
  const msgEl = document.getElementById("msg");
  const slotEl = document.getElementById("slot");
  const wheelEl = document.getElementById("wheel");
  const hintEl = document.getElementById("hint");
  const resEl = document.getElementById("resultado");
  const toast2 = document.getElementById("toast2");

  const btnAdd = document.getElementById("btnAdd");
  const btnExemplo = document.getElementById("btnExemplo");
  const btnReset = document.getElementById("btnReset");
  const btnGerar = document.getElementById("btnGerar");
  const btnRevelar = document.getElementById("btnRevelar");
  const btnOcultar = document.getElementById("btnOcultar");

  const novoNomeEl = document.getElementById("novoNome");
  const kTotal = document.getElementById("kTotal");
  const kDone = document.getElementById("kDone");

  const modoEl = document.getElementById("modo");
  const qtdEl = document.getElementById("qtd");

  // ---------- UI helpers ----------
  const toast = (text) => {
    msgEl.textContent = text || "";
    if(text) setTimeout(()=>{ if(msgEl.textContent === text) msgEl.textContent=""; }, 2200);
  };
  const toastRight = (text) => {
    toast2.textContent = text || "";
    if(text) setTimeout(()=>{ if(toast2.textContent === text) toast2.textContent=""; }, 2600);
  };
  const setStatus = (t) => statusEl.textContent = t;

  const updateKPIs = () => {
    kTotal.textContent = names.length;
    kDone.textContent = revealed.size;
  };

  function render(){
    chipsEl.innerHTML = "";

    names.forEach((n)=>{
      const chip = document.createElement("div");
      chip.className = "chip" +
        (n === selected ? " selected":"") +
        (revealed.has(n) ? " done":"");

      const left = document.createElement("div");
      left.style.display="flex";
      left.style.flexDirection="column";
      left.style.gap="2px";

      const strong = document.createElement("strong");
      strong.textContent = n;

      const small = document.createElement("small");
      small.textContent = revealed.has(n) ? "marcado ‚úÖ" : "toque para selecionar";

      left.appendChild(strong);
      left.appendChild(small);

      const actions = document.createElement("div");
      actions.style.display="flex";
      actions.style.gap="2px";
      actions.style.marginLeft="8px";

      const edit = document.createElement("button");
      edit.className = "miniBtn edit";
      edit.type = "button";
      edit.textContent = "‚úèÔ∏è";
      edit.title = "Editar";
      edit.onclick = (e)=>{ e.stopPropagation(); editar(n); };

      const del = document.createElement("button");
      del.className = "miniBtn del";
      del.type = "button";
      del.textContent = "üóëÔ∏è";
      del.title = "Excluir";
      del.onclick = (e)=>{ e.stopPropagation(); excluir(n); };

      actions.appendChild(edit);
      actions.appendChild(del);

      chip.appendChild(left);
      chip.appendChild(actions);

      chip.onclick = ()=> selecionar(n);
      chipsEl.appendChild(chip);
    });

    // Modo: no amigo oculto precisa selecionar para revelar; nos outros modos n√£o.
    const mode = modoEl.value;
    const canReveal = drawReady && (mode !== "amigo" || !!selected);
    btnRevelar.disabled = !canReveal;
    btnOcultar.disabled = !drawReady;

    // hint
    if(mode === "amigo"){
      hintEl.textContent = "Modo Amigo: selecione seu nome e clique REVELAR.";
    } else if(mode === "simples"){
      hintEl.textContent = "Sorteio simples: clique REVELAR para sortear 1 ganhador.";
    } else if(mode === "multi"){
      hintEl.textContent = "Sorteio multi: clique REVELAR para sortear N ganhadores.";
    } else {
      hintEl.textContent = "Ordem aleat√≥ria: clique REVELAR para embaralhar e mostrar a ordem.";
    }

    // qtd s√≥ faz sentido no multi
    qtdEl.style.opacity = (mode === "multi") ? "1" : ".55";
    qtdEl.disabled = (mode !== "multi");

    updateKPIs();
    saveState();
  }

  function selecionar(n){
    selected = (selected === n ? null : n);
    resEl.className = "result";
    resEl.textContent = drawReady ? "Pronto. Toque em REVELAR." : "Gere primeiro.";
    render();
  }

  // ---------- CRUD ----------
  function adicionar(){
    const v = novoNomeEl.value.trim();
    if(!v) return toast("Digite algo üôÇ");
    if(names.some(x=>x.toLowerCase() === v.toLowerCase())) return toast("J√° existe.");
    names.push(v);
    novoNomeEl.value = "";

    if(drawReady){ invalidateDraw("Lista mudou. Gere de novo."); }
    render();
  }

  function editar(oldName){
    const novo = prompt("Editar:", oldName);
    if(novo === null) return;
    const v = novo.trim();
    if(!v) return toast("Nome vazio n√£o vale.");
    if(names.some(x => x !== oldName && x.toLowerCase() === v.toLowerCase())) return toast("J√° existe outro igual.");

    names = names.map(x => x===oldName ? v : x);
    if(selected === oldName) selected = v;

    if(drawReady){ invalidateDraw("Lista mudou. Gere de novo."); }
    render();
  }

  function excluir(n){
    if(!confirm(`Excluir "${n}"?`)) return;
    names = names.filter(x=>x!==n);
    if(selected === n) selected = null;

    if(drawReady){ invalidateDraw("Lista mudou. Gere de novo."); }
    render();
  }

  function resetAll(){
    if(!confirm("Resetar tudo?")) return;
    names = [];
    selected = null;
    pairs = {};
    revealed = new Set();
    drawReady = false;
    setStatus("sem sorteio");
    resEl.className="result";
    resEl.textContent="Aguardando‚Ä¶";
    render();
  }

  function loadExample(){
    names = [
      "Ernandes (filho)","Seu Ernandes (pai)","Dona Elza","B√°rbara","Sara","Davi",
      "Ana Luiza","Juliana","Daniel","Th√©o","Elen","√Ålvaro","Sueli","Ferraz","Bia","Stefan"
    ];
    selected = null;
    invalidateDraw("Exemplo carregado. Gere o sorteio.");
    render();
  }

  function invalidateDraw(message){
    drawReady = false;
    pairs = {};
    revealed = new Set();
    selected = null;
    setStatus("sem sorteio");
    resEl.className="result";
    resEl.textContent = message || "Gere o sorteio.";
  }

  // ---------- Draw logic ----------
  function makeDerangement(list){
    // used for amigo oculto
    for(let t=0;t<8000;t++){
      const s = [...list].sort(()=>Math.random()-0.5);
      let ok = true;
      for(let i=0;i<list.length;i++){
        if(list[i] === s[i]) { ok=false; break; }
      }
      if(ok) return s;
    }
    return null;
  }

  function confettiBoom(){
    const host = document.getElementById("confetti");
    host.innerHTML="";
    const colors = ["#a78bfa","#34d399","#fbbf24","#60a5fa","#fb7185","#f472b6"];
    const count = 26;
    for(let i=0;i<count;i++){
      const p = document.createElement("i");
      p.style.left = (Math.random()*100) + "vw";
      p.style.top = (-10 - Math.random()*30) + "px";
      p.style.background = colors[Math.floor(Math.random()*colors.length)];
      p.style.animationDuration = (850 + Math.random()*650) + "ms";
      p.style.width = (8 + Math.random()*8) + "px";
      p.style.height = (10 + Math.random()*14) + "px";
      host.appendChild(p);
    }
    setTimeout(()=>{ host.innerHTML=""; }, 1500);
  }

  async function rollAnimation(){
    wheelEl.classList.add("rolling");
    let i=0;
    const timer = setInterval(()=>{
      slotEl.textContent = faces[i % faces.length];
      i++;
    }, 70);
    await new Promise(r=>setTimeout(r, 1050));
    clearInterval(timer);
    wheelEl.classList.remove("rolling");
    slotEl.textContent = "üé≤";
  }

  async function gerar(){
    const mode = modoEl.value;
    if(names.length < 2) return toast("Coloque pelo menos 2 itens.");

    btnGerar.disabled = true;
    setStatus("sorteando...");
    resEl.className="result";
    resEl.textContent="Tchannn‚Ä¶";
    await rollAnimation();

    if(mode === "amigo"){
      const der = makeDerangement(names);
      if(!der){
        setStatus("falhou");
        resEl.className="result bad";
        resEl.textContent="N√£o consegui montar pares sem algu√©m tirar a si mesmo. Tente de novo.";
        btnGerar.disabled = false;
        return;
      }
      pairs = {};
      names.forEach((n,idx)=> pairs[n] = der[idx]);
      drawReady = true;
      revealed = new Set();
      selected = null;
      setStatus("feito ‚úÖ");
      resEl.textContent = "Sorteio de amigo oculto pronto. Selecione seu nome e REVELE.";
      confettiBoom();
    } else {
      // outros modos: apenas marca pronto (revelar far√° o sorteio)
      drawReady = true;
      revealed = new Set();
      selected = null;
      setStatus("pronto ‚úÖ");
      resEl.textContent = "Pronto. Clique REVELAR para ver o resultado do modo escolhido.";
      confettiBoom();
    }

    btnGerar.disabled = false;
    render();
  }

  function revealSimple(){
    // 1 ganhador
    const winner = names[Math.floor(Math.random()*names.length)];
    resEl.className="result ok";
    resEl.innerHTML = `üèÜ <b>Ganhador(a):</b><br><br><span style="font-size:22px;font-weight:900">${winner}</span>`;
    confettiBoom();
  }

  function revealMulti(){
    let n = parseInt(qtdEl.value || "1", 10);
    if(isNaN(n) || n<1) n = 1;
    n = Math.min(n, names.length);

    const shuffled = [...names].sort(()=>Math.random()-0.5);
    const winners = shuffled.slice(0, n);

    resEl.className="result ok";
    resEl.innerHTML = `üèÜ <b>${n} ganhador(es):</b><br><br>${winners.map(w=>`‚Ä¢ <b>${w}</b>`).join("<br>")}`;
    confettiBoom();
  }

  function revealOrder(){
    const order = [...names].sort(()=>Math.random()-0.5);
    resEl.className="result ok";
    resEl.innerHTML = `üìã <b>Ordem sorteada:</b><br><br>${order.map((w,i)=>`${i+1}. <b>${w}</b>`).join("<br>")}`;
    confettiBoom();
  }

  function revelar(){
    const mode = modoEl.value;

    if(!drawReady){
      resEl.className="result bad";
      resEl.textContent="Gere primeiro.";
      return;
    }

    if(mode === "amigo"){
      if(!selected){
        resEl.className="result bad";
        resEl.textContent="Selecione seu nome primeiro.";
        return;
      }
      if(revealed.has(selected)){
        resEl.className="result bad";
        resEl.textContent="Esse j√° revelou ‚úÖ";
        return;
      }
      const friend = pairs[selected];
      resEl.className="result ok";
      resEl.innerHTML = `<b>${selected}</b>, seu amigo oculto √©:<br><br>üéÅ <span style="font-size:20px;font-weight:900">${friend}</span>`;
      revealed.add(selected);
      confettiBoom();
      render();
      return;
    }

    if(mode === "simples") return revealSimple();
    if(mode === "multi") return revealMulti();
    return revealOrder();
  }

  function ocultar(){
    resEl.className="result";
    resEl.textContent = "Oculto. Pr√≥ximo!";
    selected = null;
    render();
  }

  // ---------- Events ----------
  btnAdd.addEventListener("click", adicionar);
  novoNomeEl.addEventListener("keydown", (e)=>{ if(e.key === "Enter") adicionar(); });

  btnReset.addEventListener("click", resetAll);
  btnExemplo.addEventListener("click", loadExample);

  btnGerar.addEventListener("click", gerar);
  btnRevelar.addEventListener("click", revelar);
  btnOcultar.addEventListener("click", ocultar);

  modoEl.addEventListener("change", () => {
    invalidateDraw("Modo mudou. Clique GERAR.");
    render();
  });

  // ---------- Init ----------
  if(!loadState()){
    loadExample();
  } else {
    // se carregar do storage e tiver modo, deixa consistente
    resEl.className = "result";
    resEl.textContent = drawReady ? "Pronto. Clique REVELAR." : "Clique GERAR.";
    setStatus(drawReady ? "pronto ‚úÖ" : "sem sorteio");
  }
  render();

  // ---------- Service Worker register (CORRETO) ----------
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service-worker.js").catch(()=>{});
  }
})();
</script>

</body>
</html>
